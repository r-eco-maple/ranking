name: Deploy React App with Data

on:
  repository_dispatch:
    types: [scraping-completed] # GAS ã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å—ä¿¡
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Fetch latest ranking data
        env:
          GAS_API_KEY: ${{ secrets.GAS_API_KEY }}
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p ranking-data/data
          cd ranking-data

          echo "ğŸ” Fetching data from GAS..."

          # APIã‚­ãƒ¼ã®ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "DEBUG: API Key length: ${#GAS_API_KEY}"
          echo "DEBUG: API Key content: $GAS_API_KEY"

          # ãƒ¡ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—
          echo "ğŸ“Š Fetching main ranking data..."
          for i in {1..3}; do
            echo "Main ranking attempt $i/3..."
            
            # User-Agentãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹
            if curl -f -s -L -o data/ranking.json \
              -H "User-Agent: Mozilla/5.0 (compatible; GitHub-Actions)" \
              "https://script.google.com/macros/s/AKfycbwOxOppce1dLNhYI3F3IfznonZZI5hIRYFg5Rmu-CLa73KUGJk3ek4o9hAFnxm7F6zn7A/exec?apiKey=$GAS_API_KEY&cache_bust=$(date +%s)"; then
              
              echo "âœ… Main data fetched, checking content..."
              
              # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
              echo "Response size: $(wc -c < data/ranking.json) bytes"
              echo "First 200 characters:"
              head -c 200 data/ranking.json
              echo -e "\n---"
              
              # JSONå½¢å¼ãƒã‚§ãƒƒã‚¯
              if jq empty data/ranking.json 2>/dev/null; then
                echo "âœ… Valid JSON received"
                
                # ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒã‚§ãƒƒã‚¯
                if jq -e '.success and .data and (.data | type) == "array"' data/ranking.json > /dev/null; then
                  echo "âœ… Valid data structure"
                  echo "Main data count: $(jq '.data | length' data/ranking.json) records"
                  break
                else
                  echo "âŒ Invalid data structure"
                  echo "Response content:"
                  cat data/ranking.json
                fi
              else
                echo "âŒ Invalid JSON format"
                echo "Response content:"
                cat data/ranking.json
                
                # HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’æŠ½å‡º
                REDIRECT_URL=$(grep -o 'https://script.googleusercontent.com[^"\n]*' data/ranking.json | head -1)
                if [ ! -z "$REDIRECT_URL" ]; then
                  echo "ğŸ”„ Found redirect URL, trying: $REDIRECT_URL"
                  if curl -f -s -L -o data/ranking.json "$REDIRECT_URL"; then
                    echo "âœ… Redirect successful, checking content..."
                    if jq empty data/ranking.json 2>/dev/null; then
                      echo "âœ… Valid JSON from redirect"
                      break
                    fi
                  fi
                fi
              fi
            else
              echo "âŒ Failed to fetch main data (HTTP error)"
            fi
            
            if [ $i -lt 3 ]; then
              echo "Retrying in 30 seconds..."
              sleep 30
            fi
          done

          # ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
          if ! jq empty data/ranking.json 2>/dev/null; then
            echo "âŒ All main data attempts failed - using fallback data"
            cat > data/ranking.json << 'EOF'
          {
            "success": false,
            "data": [],
            "error": "Failed to fetch data from GAS",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          fi

          # ãƒãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—
          echo "ğŸ”¥ Fetching burning ranking data..."
          for i in {1..3}; do
            echo "Burning ranking attempt $i/3..."
            
            # ãƒãƒ¼ãƒ‹ãƒ³ã‚°ã‚·ãƒ¼ãƒˆæŒ‡å®šã§ãƒ‡ãƒ¼ã‚¿å–å¾—
            if curl -f -s -L -o data/ranking_burning.json \
              -H "User-Agent: Mozilla/5.0 (compatible; GitHub-Actions)" \
              "https://script.google.com/macros/s/AKfycbwOxOppce1dLNhYI3F3IfznonZZI5hIRYFg5Rmu-CLa73KUGJk3ek4o9hAFnxm7F6zn7A/exec?apiKey=$GAS_API_KEY&sheet=burning&cache_bust=$(date +%s)"; then
              
              echo "âœ… Burning data fetched, checking content..."
              
              # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
              echo "Burning response size: $(wc -c < data/ranking_burning.json) bytes"
              echo "First 200 characters:"
              head -c 200 data/ranking_burning.json
              echo -e "\n---"
              
              # JSONå½¢å¼ãƒã‚§ãƒƒã‚¯
              if jq empty data/ranking_burning.json 2>/dev/null; then
                echo "âœ… Valid burning JSON received"
                
                # ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒã‚§ãƒƒã‚¯
                if jq -e '.success and .data and (.data | type) == "array"' data/ranking_burning.json > /dev/null; then
                  echo "âœ… Valid burning data structure"
                  echo "Burning data count: $(jq '.data | length' data/ranking_burning.json) records"
                  break
                else
                  echo "âŒ Invalid burning data structure"
                  echo "Response content:"
                  cat data/ranking_burning.json
                fi
              else
                echo "âŒ Invalid burning JSON format"
                echo "Response content:"
                cat data/ranking_burning.json
                
                # HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’æŠ½å‡º
                REDIRECT_URL=$(grep -o 'https://script.googleusercontent.com[^"\n]*' data/ranking_burning.json | head -1)
                if [ ! -z "$REDIRECT_URL" ]; then
                  echo "ğŸ”„ Found burning redirect URL, trying: $REDIRECT_URL"
                  if curl -f -s -L -o data/ranking_burning.json "$REDIRECT_URL"; then
                    echo "âœ… Burning redirect successful, checking content..."
                    if jq empty data/ranking_burning.json 2>/dev/null; then
                      echo "âœ… Valid burning JSON from redirect"
                      break
                    fi
                  fi
                fi
              fi
            else
              echo "âŒ Failed to fetch burning data (HTTP error)"
            fi
            
            if [ $i -lt 3 ]; then
              echo "Retrying burning data in 30 seconds..."
              sleep 30
            fi
          done

          # ãƒãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
          if ! jq empty data/ranking_burning.json 2>/dev/null; then
            echo "âŒ All burning data attempts failed - using fallback data"
            cat > data/ranking_burning.json << 'EOF'
          {
            "success": false,
            "data": [],
            "error": "Failed to fetch burning data from GAS",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          fi

      - name: Update metadata
        run: |
          cd ranking-data

          # ãƒ¡ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          echo "ğŸ“Š Creating main ranking metadata..."
          DATA_COUNT=$(jq -r '.data | length // 0' data/ranking.json 2>/dev/null || echo "0")
          SUCCESS_STATUS=$(jq -r '.success // false' data/ranking.json 2>/dev/null || echo "false")

          cat > data/meta.json << EOF
          {
            "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "timezone": "UTC", 
            "source": "MapleStory Ranking System",
            "updateFrequency": "Daily at 09:00 JST",
            "dataCount": $DATA_COUNT,
            "success": $SUCCESS_STATUS,
            "buildNumber": "${{ github.run_number }}"
          }
          EOF
          echo "âœ… Main metadata updated (Records: $DATA_COUNT, Success: $SUCCESS_STATUS)"

          # ãƒãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          echo "ğŸ”¥ Creating burning ranking metadata..."
          BURNING_DATA_COUNT=$(jq -r '.data | length // 0' data/ranking_burning.json 2>/dev/null || echo "0")
          BURNING_SUCCESS_STATUS=$(jq -r '.success // false' data/ranking_burning.json 2>/dev/null || echo "false")

          cat > data/meta-ranking_burning.json << EOF
          {
            "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "timezone": "UTC", 
            "source": "MapleStory Burning Ranking System",
            "updateFrequency": "Daily at 09:00 JST",
            "dataCount": $BURNING_DATA_COUNT,
            "success": $BURNING_SUCCESS_STATUS,
            "buildNumber": "${{ github.run_number }}"
          }
          EOF
          echo "âœ… Burning metadata updated (Records: $BURNING_DATA_COUNT, Success: $BURNING_SUCCESS_STATUS)"

      - name: Install React dependencies
        run: |
          npm ci

      - name: Build React application
        run: |
          npm run build:prod
          echo "âœ… React app built successfully in production mode"

      - name: Prepare deployment directory
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p deploy

          # Reactãƒ“ãƒ«ãƒ‰çµæœã‚’ã‚³ãƒ”ãƒ¼
          cp -r dist/* deploy/

          # ãƒ‡ãƒãƒƒã‚°: ranking-dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ç¢ºèª
          echo "DEBUG: ranking-data directory contents:"
          ls -la ranking-data/
          echo "DEBUG: ranking-data/data directory contents:"
          ls -la ranking-data/data/ || echo "data directory not found"

          # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ã®dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p deploy/api
          if [ -f ranking-data/data/ranking.json ]; then
            cp ranking-data/data/*.json deploy/api/
            # ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã§ã‚‚APIã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
            cp ranking-data/data/*.json deploy/
            echo "âœ… JSON files copied successfully"
          else
            echo "âŒ ranking.json not found in ranking-data/data/"
          fi

          # APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚é…ç½®ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f ranking-data/data/index.html ]; then
            cp ranking-data/data/index.html deploy/api/
          fi

          echo "âœ… Deployment directory prepared"

      - name: Create API redirect for better UX
        run: |
          # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆ
          cat > deploy/_redirects << EOF
          /api/ranking.json /ranking.json 200
          /api/ranking_burning.json /ranking_burning.json 200
          /api/meta.json /meta.json 200
          /api/meta-ranking_burning.json /meta-ranking_burning.json 200
          /api/* /api/:splat 200
          /* /index.html 200
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./deploy"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Output deployment info
        run: |
          echo "ğŸš€ Deployment completed!"
          echo "ğŸ“± React App: https://r-eco-maple.github.io/ranking/"
          echo "ğŸ“Š Main Ranking API: https://r-eco-maple.github.io/ranking/ranking.json"
          echo "ğŸ”¥ Burning Ranking API: https://r-eco-maple.github.io/ranking/ranking_burning.json"
          echo "ğŸ“„ API Docs: https://r-eco-maple.github.io/ranking/api/"
